<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel CEO - Daradigu</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 text-gray-900">

  <div class="max-w-4xl mx-auto p-8">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">Panel del CEO</h1>
      <button onclick="cerrarSesion()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-700">
        Cerrar sesión
      </button>
    </div>

    <!-- Métricas -->
    <div id="metricas" class="bg-white p-4 rounded shadow mb-6 text-sm text-gray-700 space-y-1"></div>

    <!-- Buscar y crear -->
    <div class="flex justify-between items-center mb-4">
      <input type="text" id="busqueda" oninput="filtrarProyectos()" placeholder="Buscar por título..." class="w-2/3 border rounded p-2" />
      <a href="crear.html" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Nuevo proyecto</a>
    </div>

    <div id="proyectos" class="space-y-4"></div>
  </div>

  <!-- Modal edición -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white p-6 rounded shadow w-full max-w-md">
      <h2 class="text-xl font-bold mb-4">Editar proyecto</h2>
      <input id="edit-titulo" class="w-full border rounded p-2 mb-2" />
      <textarea id="edit-contenido" class="w-full border rounded p-2 mb-4"></textarea>
      <div class="flex justify-between">
        <button onclick="guardarCambios()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Guardar</button>
        <button onclick="cerrarModal()" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    const supabase = supabase.createClient(
      "https://bmvcxcqueeueesj1lg.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJibXZjY3F3Y3VlZXVlc3BqbGlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxNjY5MjgsImV4cCI6MjA2NDc0MjkyOH0.MS11K1Mhhha_GHh81_a3JtuQ4qBQWkeV2gNIGUAkieg"
    );

    let proyectos = [];
    let usuario = null;
    let proyectoEditandoId = null;

    async function cargarProyectos() {
      usuario = (await supabase.auth.getUser()).data.user;
      if (!usuario) {
        alert("Debes iniciar sesión");
        window.location.href = "inicio.html";
        return;
      }

      const { data, error } = await supabase
        .from("proyectos")
        .select()
        .eq("user_id", usuario.id)
        .order("fecha", { ascending: false });

      if (error) return alert("Error al cargar proyectos");

      proyectos = data;
      renderizarMetricas();
      renderizarProyectos();
    }

    function renderizarMetricas() {
      const contenedor = document.getElementById("metricas");

      if (proyectos.length === 0) {
        contenedor.innerHTML = "Sin proyectos aún.";
        return;
      }

      const total = proyectos.length;
      const ultimo = proyectos[0];
      const fechaUltimo = new Date(ultimo.fecha);
      const ahora = new Date();
      const diffMin = Math.floor((ahora - fechaUltimo) / 60000);

      contenedor.innerHTML = `
        <div><strong>Total de proyectos:</strong> ${total}</div>
        <div><strong>Último creado:</strong> ${ultimo.titulo}</div>
        <div><strong>Hace:</strong> ${diffMin} minutos</div>
      `;
    }

    function renderizarProyectos() {
      const contenedor = document.getElementById("proyectos");
      contenedor.innerHTML = "";

      if (proyectos.length === 0) {
        contenedor.innerHTML = "<p>No hay proyectos aún.</p>";
        return;
      }

      proyectos.forEach(p => {
        const div = document.createElement("div");
        div.className = "bg-white p-4 rounded shadow";
        div.innerHTML = `
          <h2 class="text-xl font-bold">${p.titulo}</h2>
          <p class="text-gray-700 mt-1">${p.contenido}</p>
          <p class="text-sm text-gray-500 mt-2">${new Date(p.fecha).toLocaleString()}</p>
          <div class="flex gap-2 mt-3">
            <button onclick="abrirModal('${p.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Editar</button>
            <button onclick="eliminarProyecto('${p.id}')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Eliminar</button>
          </div>
        `;
        contenedor.appendChild(div);
      });
    }

    function filtrarProyectos() {
      const query = document.getElementById("busqueda").value.toLowerCase();
      const filtrados = proyectos.filter(p => p.titulo.toLowerCase().includes(query));
      renderizarFiltrados(filtrados);
    }

    function renderizarFiltrados(lista) {
      const contenedor = document.getElementById("proyectos");
      contenedor.innerHTML = "";

      if (lista.length === 0) {
        contenedor.innerHTML = "<p>No se encontraron proyectos.</p>";
        return;
      }

      lista.forEach(p => {
        const div = document.createElement("div");
        div.className = "bg-white p-4 rounded shadow";
        div.innerHTML = `
          <h2 class="text-xl font-bold">${p.titulo}</h2>
          <p class="text-gray-700 mt-1">${p.contenido}</p>
          <p class="text-sm text-gray-500 mt-2">${new Date(p.fecha).toLocaleString()}</p>
          <div class="flex gap-2 mt-3">
            <button onclick="abrirModal('${p.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Editar</button>
            <button onclick="eliminarProyecto('${p.id}')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Eliminar</button>
          </div>
        `;
        contenedor.appendChild(div);
      });
    }

    function abrirModal(id) {
      const proyecto = proyectos.find(p => p.id === id);
      if (!proyecto) return;

      proyectoEditandoId = id;
      document.getElementById("edit-titulo").value = proyecto.titulo;
      document.getElementById("edit-contenido").value = proyecto.contenido;
      document.getElementById("modal").classList.remove("hidden");
      document.getElementById("modal").classList.add("flex");
    }

    function cerrarModal() {
      proyectoEditandoId = null;
      document.getElementById("modal").classList.add("hidden");
      document.getElementById("modal").classList.remove("flex");
    }

    async function guardarCambios() {
      const nuevoTitulo = document.getElementById("edit-titulo").value;
      const nuevoContenido = document.getElementById("edit-contenido").value;

      const { error } = await supabase
        .from("proyectos")
        .update({ titulo: nuevoTitulo, contenido: nuevoContenido })
        .eq("id", proyectoEditandoId);

      if (!error) {
        cerrarModal();
        cargarProyectos();
      } else {
        alert("Error al guardar cambios");
      }
    }

    async function eliminarProyecto(id) {
      const confirmar = confirm("¿Seguro que deseas eliminar este proyecto?");
      if (!confirmar) return;

      const { error } = await supabase.from("proyectos").delete().eq("id", id);
      if (!error) cargarProyectos();
      else alert("Error al eliminar");
    }

    function cerrarSesion() {
      supabase.auth.signOut().then(() => {
        window.location.href = "inicio.html";
      });
    }

    cargarProyectos();
  </script>

</body>
</html>
